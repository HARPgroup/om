#!/bin/bash

parent_pid=$1
prop_name=$2
entity_type=$3

delete_sql="

BEGIN; \n

create temp table tmp_exist_prop as select * from dh_properties_fielded limit 0; \n

WITH RECURSIVE exist_prop AS ( \n
      SELECT p.*
      FROM dh_properties_fielded as p 
      WHERE p.featureid = $parent_pid
        AND propname = '$prop_name' 
        AND p.entity_type = '$entity_type'
      UNION
      SELECT c.*
      FROM dh_properties_fielded as c 
      inner join exist_prop as p
      on (c.featureid = p.pid and c.entity_type = 'dh_properties')
    ) \n
INSERT INTO tmp_exist_prop SELECT * from exist_prop; \n

DELETE FROM dh_properties where pid in (select pid from tmp_exist_prop); \n

DELETE FROM dh_properties_revision where pid in (select pid from tmp_exist_prop); \n

COMMIT; \n
"
set -f
echo -e $delete_sql
